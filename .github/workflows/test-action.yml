# =============================================================================
# Test markupr GitHub Action
# =============================================================================
# Validates the markupr-action works correctly.
# Runs on PRs that modify the action, and on manual dispatch.
# =============================================================================

name: Test Action

on:
  pull_request:
    paths:
      - 'markupr-action/**'
      - '.github/workflows/test-action.yml'
  workflow_dispatch:
    inputs:
      video-url:
        description: 'URL to a test video file (optional)'
        required: false
        default: ''

concurrency:
  group: test-action-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Validate action.yml schema
  # ===========================================================================
  validate:
    name: Validate action.yml
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify action.yml exists and is valid YAML
        run: |
          if [ ! -f markupr-action/action.yml ]; then
            echo "::error::markupr-action/action.yml not found"
            exit 1
          fi
          # Basic YAML validation via python
          python3 -c "
          import yaml, sys
          with open('markupr-action/action.yml') as f:
              data = yaml.safe_load(f)
          assert 'inputs' in data, 'Missing inputs'
          assert 'outputs' in data, 'Missing outputs'
          assert 'runs' in data, 'Missing runs'
          assert data['runs']['using'] == 'composite', 'Must be composite action'
          print('action.yml validated successfully')
          "

      - name: Verify entrypoint.sh is executable-ready
        run: |
          if [ ! -f markupr-action/entrypoint.sh ]; then
            echo "::error::entrypoint.sh not found"
            exit 1
          fi
          # Check it has a shebang
          head -1 markupr-action/entrypoint.sh | grep -q '^#!/' || {
            echo "::error::entrypoint.sh missing shebang"
            exit 1
          }
          echo "entrypoint.sh looks good"

      - name: Verify required inputs are defined
        run: |
          python3 -c "
          import yaml
          with open('markupr-action/action.yml') as f:
              data = yaml.safe_load(f)
          inputs = data.get('inputs', {})
          required = ['video-path', 'github-token']
          for r in required:
              assert r in inputs, f'Missing required input: {r}'
              print(f'  Found input: {r}')
          outputs = data.get('outputs', {})
          expected_outputs = ['report-path', 'issues-created']
          for o in expected_outputs:
              assert o in outputs, f'Missing output: {o}'
              print(f'  Found output: {o}')
          print('All required inputs and outputs present')
          "

  # ===========================================================================
  # Dry run with synthetic test video
  # ===========================================================================
  dry-run:
    name: Dry run (synthetic video)
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ffmpeg
        run: sudo apt-get update -qq && sudo apt-get install -y -qq ffmpeg

      - name: Generate synthetic test video
        run: |
          # Create a 5-second test video with color bars and silence
          ffmpeg -f lavfi -i "color=c=blue:s=1280x720:d=5" \
                 -f lavfi -i "anullsrc=r=44100:cl=mono" \
                 -shortest -c:v libx264 -preset ultrafast -c:a aac \
                 -y test-recording.mp4
          echo "Generated test video: $(ls -lh test-recording.mp4)"

      - name: Run markupr analyze directly
        run: |
          npx --yes markupr@latest analyze test-recording.mp4 \
            --output ./test-output \
            --verbose || echo "::warning::Analysis exited with non-zero (expected for synthetic video)"

      - name: Check output
        run: |
          echo "=== Output directory ==="
          ls -la ./test-output/ 2>/dev/null || echo "No output directory created"
          echo ""
          echo "=== Markdown files ==="
          find ./test-output -name "*.md" -type f 2>/dev/null || echo "No markdown files found"

      - name: Upload test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-action-output
          path: ./test-output/
          if-no-files-found: warn
          retention-days: 7

  # ===========================================================================
  # Test composite action steps (mocked)
  # ===========================================================================
  integration:
    name: Integration test
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ffmpeg
        run: sudo apt-get update -qq && sudo apt-get install -y -qq ffmpeg

      - name: Generate test video
        run: |
          ffmpeg -f lavfi -i "color=c=red:s=640x480:d=3" \
                 -f lavfi -i "anullsrc=r=44100:cl=mono" \
                 -shortest -c:v libx264 -preset ultrafast -c:a aac \
                 -y recordings/test.mp4
        env:
          # Suppress ffmpeg banner
          AV_LOG_FORCE_NOCOLOR: '1'

      - name: Test entrypoint.sh directly
        run: |
          chmod +x markupr-action/entrypoint.sh
          INPUT_OUTPUT_DIR=./integration-output \
            bash markupr-action/entrypoint.sh recordings/test.mp4 || {
              echo "::warning::Entrypoint exited non-zero (acceptable for synthetic video)"
            }

      - name: Verify entrypoint output structure
        run: |
          echo "=== Integration output ==="
          ls -laR ./integration-output/ 2>/dev/null || echo "No output (expected for synthetic)"

      - name: Test directory processing
        run: |
          INPUT_OUTPUT_DIR=./dir-output \
            bash markupr-action/entrypoint.sh recordings/ || {
              echo "::warning::Directory processing exited non-zero (acceptable for synthetic)"
            }

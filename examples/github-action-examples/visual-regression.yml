# Visual Regression
# Records E2E test runs with xvfb + ffmpeg, then analyzes the recording with markupr
# to detect visual regressions and post a report on the PR.
#
# Setup:
# 1. Ensure your E2E tests run in a browser (Playwright, Cypress, etc.)
# 2. This workflow records the test run as a video, then analyzes it

name: Visual Regression Check

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  visual-check:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Install xvfb
        run: sudo apt-get update -qq && sudo apt-get install -y -qq xvfb ffmpeg

      - name: Record E2E test run
        run: |
          # Start a virtual display
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2

          # Start recording the display
          ffmpeg -f x11grab -video_size 1920x1080 -i :99 \
            -c:v libx264 -preset ultrafast -crf 28 \
            -t 120 ./test-recording.mp4 &
          FFMPEG_PID=$!

          # Run your E2E tests (replace with your test command)
          npm run test:e2e || true

          # Stop recording
          kill $FFMPEG_PID 2>/dev/null || true
          wait $FFMPEG_PID 2>/dev/null || true

      - name: Analyze recording for visual issues
        uses: eddiesanjuan/markupr-action@v1
        with:
          video-path: ./test-recording.mp4
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-on-pr: 'true'
